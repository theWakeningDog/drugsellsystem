<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sellsystem.dao.DrugDao">
    <sql id="drugSQL">
        drug.id drugId, drug.no drugNo, drug.name drugName, drug.origin drugOrigin,
        drug.unit drugUnit, drug.number drugNumber, drug.purchase drugPurchase, drug.retail drugRetail,
        drug.period drugPeriod, drug.commonName drugCommonName, drug.createTime drugCreateTime, drug.remark drugRemark
    </sql>

    <resultMap id="drugResult" type="Drug">
        <id property="id" column="drugId"/>
        <result property="no" column="drugNo"/>
        <result property="name" column="drugName"/>
        <result property="origin" column="drugOrigin"/>
        <result property="unit" column="drugUnit"/>
        <result property="number" column="drugNumber"/>
        <result property="purchase" column="drugPurchase"/>
        <result property="retail" column="drugRetail"/>
        <result property="period" column="drugPeriod"/>
        <result property="commonName" column="drugCommonName"/>
        <result property="createTime" column="drugCreateTime"/>
        <result property="remark" column="drugRemark"/>
        <association property="sort" column="drugSort" resultMap="com.sellsystem.dao.SortDao.sortResult"/>
        <association property="warehouse" column="drugWarehouse" resultMap="com.sellsystem.dao.WarehouseDao.warehouseResult"/>
    </resultMap>

    <select id="getList" resultMap="drugResult">
        SELECT
            <include refid="drugSQL"/>,
            <include refid="com.sellsystem.dao.SortDao.sortSQL"/>,
            <include refid="com.sellsystem.dao.WarehouseDao.warehouseSQL"/>
        FROM
            drug drug
        LEFT JOIN sort sort ON drug.sort = sort.id
        LEFT JOIN warehouse warehouse ON drug.warehouse = warehouse.id
        <where>
            <if test="drugSearchModel.name != null">drug.name LIKE concat('%', #{drugSearchModel.name}, '%')</if>
            <if test="drugSearchModel.warehouseId != null">AND drug.warehouse = #{drugSearchModel.warehouseId}</if>
            <if test="drugSearchModel.sortId != null">AND drug.sort = #{drugSearchModel.sortId}</if>
            <if test="drugSearchModel.commonName != null">AND drug.commonName LIKE concat('%', #{drugSearchModel.commonName}, '%')</if>
            <if test="drugSearchModel.periodStart != null">AND drug.period > #{drugSearchModel.periodStart}</if>
            <if test="drugSearchModel.periodEnd != null">AND #{drugSearchModel.periodEnd} > drug.period</if>
        </where>
    </select>

    <select id="getDrug" parameterType="java.lang.String" resultMap="drugResult">
        SELECT
            <include refid="drugSQL"/>,
            <include refid="com.sellsystem.dao.SortDao.sortSQL"/>,
            <include refid="com.sellsystem.dao.WarehouseDao.warehouseSQL"/>
        FROM
            drug drug
        LEFT JOIN sort sort ON drug.sort = sort.id
        LEFT JOIN warehouse warehouse ON drug.warehouse = warehouse.id
        WHERE drug.id = #{drugId}
    </select>

    <insert id="create">
        <selectKey keyProperty="drug.id" resultType="java.lang.String" order="BEFORE">
            select uuid() from dual;
        </selectKey>
        insert into drug values (#{drug.id}, #{drug.no}, #{drug.name}, #{drug.origin}, #{drug.unit}, #{drug.number},
        #{drug.purchase}, #{drug.retail}, #{drug.period}, #{drug.sort.id}, #{drug.warehouse.id}, #{drug.commonName}, #{drug.createTime}, #{drug.remark});
    </insert>
    
    <update id="update">
        update drug
        <set>
            <if test="no != null">no = #{drug.no}</if>
            <if test="name != null">name = #{drug.name}</if>
            <if test="origin != null">origin = #{drug.origin}</if>
            <if test="unit != null">unit = #{drug.unit}</if>
            <if test="number != null">number = #{drug.number}</if>
            <if test="purchase != null">purchase = #{drug.purchase}</if>
            <if test="retail != null">retail = #{drug.retail}</if>
            <if test="period != null">period = #{drug.period}</if>
            <if test="commonName != null">commonName = #{drug.commonName}</if>
            <if test="createTime != null">createTime = #{drug.createTime}</if>
            <if test="remark != null">remark = #{drug.remark}</if>
            <if test="period != null">period = #{drug.period}</if>
            <if test="drug.sort != null and drug.sort.id != null">sortId = #{drug.sort.id}</if>
            <if test="drug.warehouse != null and drug.warehouse.id != null">warehouseId = #{drug.warehouse.id}</if>
        </set>
    </update>
</mapper>